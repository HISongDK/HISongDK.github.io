---
title: Hooks FAQ
date: 2021-07-21 13:22:10
tags:
---

## Hooks FAQ

- [Hooks FAQ](#hooks-faq)
  - [é‡‡çº³ç­–ç•¥](#é‡‡çº³ç­–ç•¥)
    - [å“ªä¸ªç‰ˆæœ¬çš„ React åŒ…å«äº† Hookï¼Ÿ](#å“ªä¸ªç‰ˆæœ¬çš„-react-åŒ…å«äº†-hook)
    - [æˆ‘éœ€è¦é‡å†™æ‰€æœ‰çš„ class ç»„ä»¶ä¹ˆï¼Ÿ](#æˆ‘éœ€è¦é‡å†™æ‰€æœ‰çš„-class-ç»„ä»¶ä¹ˆ)
    - [æœ‰ä»€ä¹ˆæ˜¯ Hook èƒ½åšè€Œ class åšä¸åˆ°çš„ï¼Ÿ](#æœ‰ä»€ä¹ˆæ˜¯-hook-èƒ½åšè€Œ-class-åšä¸åˆ°çš„)
    - [æˆ‘çš„ React çŸ¥è¯†è¿˜æœ‰å¤šå°‘æ˜¯ä»ç„¶æœ‰ç”¨çš„ï¼Ÿ](#æˆ‘çš„-react-çŸ¥è¯†è¿˜æœ‰å¤šå°‘æ˜¯ä»ç„¶æœ‰ç”¨çš„)
    - [æˆ‘åº”è¯¥ä½¿ç”¨ Hookï¼Œclassï¼Œè¿˜æ˜¯ä¸¤è€…æ··ç”¨ï¼Ÿ](#æˆ‘åº”è¯¥ä½¿ç”¨-hookclassè¿˜æ˜¯ä¸¤è€…æ··ç”¨)
    - [Hook èƒ½å¦è¦†ç›– class çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯ï¼Ÿ](#hook-èƒ½å¦è¦†ç›–-class-çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯)
    - [Hook ä¼šæ›¿ä»£ render props å’Œé«˜é˜¶ç»„ä»¶ä¹ˆï¼Ÿ](#hook-ä¼šæ›¿ä»£-render-props-å’Œé«˜é˜¶ç»„ä»¶ä¹ˆ)
    - [Hook å¯¹äº Redux connect() å’Œ React Router ç­‰æµè¡Œçš„ API æ¥è¯´ï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ](#hook-å¯¹äº-redux-connect-å’Œ-react-router-ç­‰æµè¡Œçš„-api-æ¥è¯´æ„å‘³ç€ä»€ä¹ˆ)
    - [Hook èƒ½å’Œé™æ€ç±»å‹ä¸€èµ·ç”¨ä¹ˆï¼Ÿ](#hook-èƒ½å’Œé™æ€ç±»å‹ä¸€èµ·ç”¨ä¹ˆ)
    - [å¦‚ä½•æµ‹è¯•ä½¿ç”¨äº† Hook çš„ç»„ä»¶ï¼Ÿ](#å¦‚ä½•æµ‹è¯•ä½¿ç”¨äº†-hook-çš„ç»„ä»¶)
    - [lint è§„åˆ™å…·ä½“å¼ºåˆ¶äº†å“ªäº›å†…å®¹ï¼Ÿ](#lint-è§„åˆ™å…·ä½“å¼ºåˆ¶äº†å“ªäº›å†…å®¹)
  - [ä» Class è¿ç§»åˆ° Hook](#ä»-class-è¿ç§»åˆ°-hook)
    - [ç”Ÿå‘½å‘¨æœŸè¦å¦‚ä½•å¯¹åº”åˆ° Hook ï¼Ÿ](#ç”Ÿå‘½å‘¨æœŸè¦å¦‚ä½•å¯¹åº”åˆ°-hook-)
    - [æˆ‘è¯¥å¦‚ä½•ä½¿ç”¨ Hook è¿›è¡Œæ•°æ®è·å–ï¼Ÿ](#æˆ‘è¯¥å¦‚ä½•ä½¿ç”¨-hook-è¿›è¡Œæ•°æ®è·å–)
    - [æœ‰ç±»ä¼¼å®ä¾‹å˜é‡çš„ä¸œè¥¿ä¹ˆï¼Ÿ](#æœ‰ç±»ä¼¼å®ä¾‹å˜é‡çš„ä¸œè¥¿ä¹ˆ)
    - [æˆ‘åº”è¯¥ä½¿ç”¨å•ä¸ªè¿˜æ˜¯å¤šä¸ª state å˜é‡ï¼Ÿ](#æˆ‘åº”è¯¥ä½¿ç”¨å•ä¸ªè¿˜æ˜¯å¤šä¸ª-state-å˜é‡)
    - [æˆ‘å¯ä»¥åªåœ¨æ›´æ–°æ—¶è¿è¡Œ effect å—ï¼Ÿ](#æˆ‘å¯ä»¥åªåœ¨æ›´æ–°æ—¶è¿è¡Œ-effect-å—)
    - [å¦‚ä½•è·å–ä¸Šä¸€è½®çš„ state æˆ– propsï¼Ÿ](#å¦‚ä½•è·å–ä¸Šä¸€è½®çš„-state-æˆ–-props)
    - [ä¸ºä»€ä¹ˆæˆ‘ä¼šåœ¨æˆ‘çš„å‡½æ•°ä¸­çœ‹åˆ°é™ˆæ—§çš„ props å’Œ stateï¼Ÿ](#ä¸ºä»€ä¹ˆæˆ‘ä¼šåœ¨æˆ‘çš„å‡½æ•°ä¸­çœ‹åˆ°é™ˆæ—§çš„-props-å’Œ-state)
    - [æˆ‘è¯¥å¦‚ä½•å®ç° getDerivedStateFromPropsï¼Ÿ](#æˆ‘è¯¥å¦‚ä½•å®ç°-getderivedstatefromprops)
    - [æœ‰ç±»ä¼¼ forceUpdate çš„ä¸œè¥¿ä¹ˆï¼Ÿ](#æœ‰ç±»ä¼¼-forceupdate-çš„ä¸œè¥¿ä¹ˆ)
    - [æˆ‘å¯ä»¥å¼•ç”¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ä¹ˆï¼Ÿ](#æˆ‘å¯ä»¥å¼•ç”¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ä¹ˆ)
    - [æˆ‘è¯¥å¦‚ä½•æµ‹é‡ DOM èŠ‚ç‚¹ï¼Ÿ](#æˆ‘è¯¥å¦‚ä½•æµ‹é‡-dom-èŠ‚ç‚¹)
  - [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
    - [æˆ‘å¯ä»¥åœ¨æ›´æ–°æ—¶æ¡å¤ effect å—ï¼Ÿ](#æˆ‘å¯ä»¥åœ¨æ›´æ–°æ—¶æ¡å¤-effect-å—)
    - [åœ¨ä¾èµ–é¡¹åˆ—è¡¨ä¸­çœç•¥å‡½æ•°æ˜¯å¦å®‰å…¨ï¼Ÿ](#åœ¨ä¾èµ–é¡¹åˆ—è¡¨ä¸­çœç•¥å‡½æ•°æ˜¯å¦å®‰å…¨)

_Hook æ˜¯ React 16.8 çš„æ–°å¢ç‰¹æ€§ã€‚å®ƒå¯ä»¥è®©ä½ åœ¨ä¸ç¼–å†™ class çš„æƒ…å†µä¸‹ä½¿ç”¨ state ä»¥åŠå…¶å®ƒçš„ React ç‰¹æ€§ã€‚_

æ­¤ç« èŠ‚å›ç­”äº†å…³äº Hook çš„å¸¸è§é—®é¢˜ã€‚

- é‡‡çº³ç­–ç•¥
  - å“ªä¸ªç‰ˆæœ¬çš„ React åŒ…å«äº† Hookï¼Ÿ
  - æˆ‘éœ€è¦é‡å†™æ‰€æœ‰çš„ class ç»„ä»¶ä¹ˆï¼Ÿ
  - æœ‰ä»€ä¹ˆæ˜¯ Hook èƒ½åšè€Œ class åšä¸åˆ°çš„ï¼Ÿ
  - æˆ‘çš„ React çŸ¥è¯†è¿˜æœ‰å¤šå°‘æ˜¯ä»ç„¶æœ‰ç”¨çš„ï¼Ÿ
  - æˆ‘åº”è¯¥ä½¿ç”¨ Hookï¼Œclassï¼Œè¿˜æ˜¯ä¸¤è€…æ··æ·†ï¼Ÿ
  - Hook èƒ½å¦è¦†ç›– class çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯ï¼Ÿ
  - Hook ä¼šä»£æ›¿ render props å’Œé«˜é˜¶ç»„ä»¶ä¹ˆï¼Ÿ
  - Hook å¯¹äº Redux connect() å’Œ ReactRouter ç­‰æµè¡Œ API æ¥è¯´ï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ
  - Hook èƒ½å’Œé™æ€ç±»å‹ä¸€èµ·ç”¨ä¹ˆï¼Ÿ
  - å¦‚ä½•æµ‹è¯•ä½¿ç”¨äº† Hook çš„ç»„ä»¶ï¼Ÿ
  - lint è§„åˆ™å…·ä½“å¼ºåˆ¶äº†å“ªäº›å†…å®¹ï¼Ÿ
- ä» class è¿ç§»åˆ° Hook
  - ç”Ÿå‘½å‘¨æœŸæ–¹æ³•è¦å¦‚ä½•å¯¹åº”åˆ° Hook ï¼Ÿ

### é‡‡çº³ç­–ç•¥

#### å“ªä¸ªç‰ˆæœ¬çš„ React åŒ…å«äº† Hookï¼Ÿ

ä» 16.8.0 å¼€å§‹ï¼ŒReact åœ¨ä»¥ä¸‹æ¨¡å—ä¸­åŒ…å«äº† ReactHook çš„ç¨³å®šå®ç°ï¼š

- ReactDOM
- ReactNative
- React DOM Server
- React Test Server
- React Shallow Renderer

**è¯·æ³¨æ„ï¼Œè¦å¯ç”¨ Hookï¼Œæ‰€æœ‰ React ç›¸å…³çš„ package éƒ½å¿…é¡»å‡çº§åˆ° 16.8.0 æˆ–æ›´é«˜ç‰ˆæœ¬ã€‚**å¦‚æœä½ å¿˜è®°æ›´æ–°è¯¸å¦‚ ReactDOM ä¹‹ç±»çš„ packageï¼ŒHook å°†æ— æ³•è¿è¡Œã€‚

ReactNative 0.59 åŠä»¥ä¸Šç‰ˆæœ¬æ”¯æŒ Hookã€‚

#### æˆ‘éœ€è¦é‡å†™æ‰€æœ‰çš„ class ç»„ä»¶ä¹ˆï¼Ÿ

ä¸ã€‚æˆ‘ä»¬å¹¶æ²¡æœ‰è®¡åˆ’ä» React ä¸­ç§»é™¤ class æˆ‘ä»¬ä¹Ÿéœ€è¦ä¸æ–­åœ°å‘å¸ƒäº§å“ï¼Œé‡å†™æˆæœ¬è¾ƒé«˜ã€‚æˆ‘ä»¬æ¨èåœ¨æ–°ä»£ç ä¸­å°è¯• Hookã€‚

#### æœ‰ä»€ä¹ˆæ˜¯ Hook èƒ½åšè€Œ class åšä¸åˆ°çš„ï¼Ÿ

Hook æä¾›äº†å¼ºå¤§è€Œå¯Œæœ‰è¡¨ç°åŠ›çš„æ–¹å¼åœ¨ç»„ä»¶ä¹‹é—´å¤ç”¨åŠŸèƒ½ã€‚é€šè¿‡[ã€è‡ªå®šä¹‰ Hook ã€‘](https://react.docschina.org/docs/hooks-custom.html)è¿™ä¸€èŠ‚å¯ä»¥äº†è§£èƒ½ç”¨å®ƒåšäº›ä»€ä¹ˆã€‚è¿™ç¯‡æ¥è‡ªä¸€ä½ React æ ¸å¿ƒå›¢é˜Ÿçš„æˆå‘˜çš„æ–‡ç« åˆ™æ›´åŠ æ·±å…¥å‰–æäº† Hook è§£é”äº†å“ªäº›æ–°çš„èƒ½åŠ›ã€‚

#### æˆ‘çš„ React çŸ¥è¯†è¿˜æœ‰å¤šå°‘æ˜¯ä»ç„¶æœ‰ç”¨çš„ï¼Ÿ

Hook æ˜¯ä½¿ç”¨ä½ å·²ç»çŸ¥é“çš„ React ç‰¹æ€§çš„ä¸€ç§æ›´ç›´æ¥çš„æ–¹å¼â€”â€”â€”â€”æ¯”å¦‚ stateï¼Œç”Ÿå‘½å‘¨æœŸï¼Œcontextï¼Œä»¥åŠ refsã€‚ä»–ä»¬å¹¶æ²¡æœ‰ä»æ ¹æœ¬ä¸Šæ”¹å˜ React çš„å·¥ä½œæ–¹å¼ï¼Œä½ å¯¹ç»„ä»¶ï¼Œpropsï¼Œä»¥åŠè‡ªé¡¶å‘ä¸‹çš„æ•°æ®æµçš„çŸ¥è¯†å¹¶æ²¡æœ‰æ”¹å˜ã€‚

Hook ç¡®å®æœ‰ä»–ä»¬è‡ªå·±çš„å­¦ä¹ æ›²çº¿ã€‚å¦‚æœè¿™ä»½æ–‡æ¡£ä¸­é—å¤±äº†ä¸€äº›ä»€ä¹ˆï¼Œæä¸€ä¸ª issueï¼Œæˆ‘ä»¬ä¼šå°½å¯èƒ½åœ°å¸®ä½ ã€‚

#### æˆ‘åº”è¯¥ä½¿ç”¨ Hookï¼Œclassï¼Œè¿˜æ˜¯ä¸¤è€…æ··ç”¨ï¼Ÿ

å½“ä½ å‡†å¤‡å¥½äº†ï¼Œæˆ‘ä»¬é¼“åŠ±ä½ åœ¨å†™æ–°ç»„ä»¶åœ°æ—¶å€™å¼€å§‹å°è¯• Hookã€‚è¯·ç¡®ä¿ä½ çš„å›¢é˜Ÿä¸­åœ°æ¯ä¸ªäººéƒ½æ„¿æ„ä½¿ç”¨å®ƒä»¬å¹¶ä¸”ç†ŸçŸ¥è¿™ä»½æ–‡æ¡£ä¸­çš„å†…å®¹ã€‚æˆ‘ä»¬ä¸æ¨èç”¨ Hook é‡å†™ä½ å·²æœ‰çš„ classï¼Œé™¤éä½ æœ¬æ¥å°±æ‰“ç®—é‡å†™å®ƒä»¬ã€‚ï¼ˆä¾‹å¦‚ï¼šä¸ºäº†ä¿®å¤ bug ï¼‰ã€‚

ä½ ä¸èƒ½åœ¨ class ç»„ä»¶ _å†…éƒ¨_ ä½¿ç”¨ Hook ï¼Œä½†æ¯«æ— ç–‘é—®ä½ å¯ä»¥åœ¨ç»„ä»¶æ ‘é‡Œæ··åˆä½¿ç”¨ class ç»„ä»¶å’Œä½¿ç”¨äº† Hook åœ°å‡½æ•°ç»„ä»¶ã€‚ä¸è®ºä¸€ä¸ªç»„ä»¶æ˜¯ class è¿˜æ˜¯ä¸€ä¸ªä½¿ç”¨äº† Hook çš„å‡½æ•°ï¼Œéƒ½åªæ˜¯è¿™ä¸ªç»„ä»¶çš„å®ç°ç»†èŠ‚è€Œå·²ã€‚é•¿è¿œæ¥çœ‹ï¼Œæˆ‘ä»¬æœŸæœ› Hook èƒ½å¤Ÿæˆä¸ºäººä»¬ç¼–å†™ React ç»„å»ºçš„ä¸»è¦æ–¹å¼ã€‚

#### Hook èƒ½å¦è¦†ç›– class çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯ï¼Ÿ

æˆ‘ä»¬ç»™ Hook è®¾å®šçš„ç›®æ ‡æ˜¯å°½æ—©è¦†ç›– class çš„æ‰€æœ‰ä½¿ç”¨åœºæ™¯ã€‚ç›®å‰æš‚æ—¶è¿˜æ²¡æœ‰å¯¹åº”ä¸å¸¸ç”¨çš„ `getSnapshotBeforeUpdate`,`getDerivedStateFromError` å’Œ `componentDidCatch`ç”Ÿå‘½å‘¨æœŸçš„ Hook ç­‰ä»·å†™æ³•ï¼Œä½†æˆ‘ä»¬è®¡åˆ’å°½æ—©æŠŠå®ƒä»¬åŠ è¿›æ¥ã€‚

ç›®å‰ Hook è¿˜å¤„äºæ—©æœŸé˜¶æ®µï¼Œä¸€äº›ç¬¬ä¸‰æ–¹çš„åº“å¯èƒ½è¿˜æš‚æ—¶æ— æ³•å…¼å®¹ Hookã€‚

#### Hook ä¼šæ›¿ä»£ render props å’Œé«˜é˜¶ç»„ä»¶ä¹ˆï¼Ÿ

é€šå¸¸ï¼Œrender props å’Œé«˜é˜¶ç»„ä»¶åªæ¸²æŸ“ä¸€ä¸ªå­èŠ‚ç‚¹ã€‚æˆ‘ä»¬è®¤ä¸ºè®© Hook æ¥æœåŠ¡è¿™ä¸ªä½¿ç”¨åœºæ™¯æ›´åŠ ç®€å•ã€‚è¿™ä¸¤ç§æ¨¡å¼ä»æœ‰ç”¨æ­¦ä¹‹åœ°ï¼Œï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªè™šæ‹Ÿæ»šåŠ¨æ¡ç»„ä»¶æˆ–è®¸ä¼šæœ‰ä¸€ä¸ª `renderItem` å±æ€§ï¼Œæˆ–æ˜¯ä¸€ä¸ªå¯è§çš„å®¹å™¨ç»„ä»¶æˆ–è®¸ä¼šæœ‰å®ƒè‡ªå·±çš„ DOM ç»“æ„ï¼‰ã€‚ä½†åœ¨å¤§éƒ¨åˆ†åœºæ™¯ä¸‹ï¼ŒHook è¶³å¤Ÿäº†ï¼Œå¹¶ä¸”èƒ½å¤Ÿå¸®åŠ©å‡å°‘åµŒå¥—ã€‚

#### Hook å¯¹äº Redux connect() å’Œ React Router ç­‰æµè¡Œçš„ API æ¥è¯´ï¼Œæ„å‘³ç€ä»€ä¹ˆï¼Ÿ

ä½ å¯ä»¥ç»§ç»­ä½¿ç”¨ä¹‹å‰çš„ APIï¼›ä»–ä»¬ä»ä¼šç»§ç»­æœ‰æ•ˆã€‚

ReactRedux ä» v7.1.0 å¼€å§‹æ”¯æŒ Hook API å¹¶æš´éœ²äº† `useDispatch` å’Œ `useSelector` ç­‰ hookã€‚

ReactRouter ä» v5.1 å¼€å§‹æ”¯æŒ hookã€‚

å…¶ä»–ç¬¬ä¸‰æ–¹åº“ä¹Ÿå°†å³å°†æ”¯æŒ hook ã€‚

#### Hook èƒ½å’Œé™æ€ç±»å‹ä¸€èµ·ç”¨ä¹ˆï¼Ÿ

Hook åœ¨è®¾è®¡é˜¶æ®µå°±è€ƒè™‘äº†é™æ€ç±»å‹çš„é—®é¢˜ã€‚å› ä¸ºå®ƒä»¬æ˜¯å‡½æ•°ï¼Œæ‰€ä»¥ä»–ä»¬æ¯”åƒé«˜é˜¶ç»„ä»¶è¿™æ ·çš„æ¨¡å¼æ›´æ˜“äºè®¾å®šæ­£ç¡®çš„ç±»å‹ã€‚æœ€æ–°ç‰ˆçš„ Flow å’Œ TypeScript React å®šä¹‰å·²ç»åŒ…å«äº†å¯¹ React Hook çš„æ”¯æŒã€‚

é‡è¦çš„æ˜¯ï¼Œåœ¨ä½ éœ€è¦ä¸¥æ ¼é™åˆ¶ç±»å‹çš„æ—¶å€™ï¼Œè‡ªå®šä¹‰ Hook èƒ½å¤Ÿå¸®ä½ é™åˆ¶ React çš„ APIã€‚React çŸ¥è¯†ç»™ä½ æä¾›äº†åŸºç¡€åŠŸèƒ½ï¼Œå…·ä½“æ€ä¹ˆç”¨å°±æ˜¯ä½ è‡ªå·±çš„äº‹äº†ã€‚

#### å¦‚ä½•æµ‹è¯•ä½¿ç”¨äº† Hook çš„ç»„ä»¶ï¼Ÿ

åœ¨ React çœ‹æ¥ï¼Œä¸€ä¸ªä½¿ç”¨äº† Hook çš„ç»„ä»¶åªä¸è¿‡æ˜¯ä¸€ä¸ªå¸¸è§„ç»„ä»¶ã€‚å¦‚æœä½ çš„æµ‹è¯•æ–¹æ¡ˆä¸ä¾èµ–äº React çš„å†…éƒ¨å®ç°ï¼Œæµ‹è¯•å¸¦ Hook çš„ç»„ä»¶åº”è¯¥å’Œä½ é€šå¸¸æµ‹è¯•ç»„ä»¶çš„æ–¹å¼æ²¡ä»€ä¹ˆå·®åˆ«ã€‚

**`æ³¨æ„ï¼š`**[æµ‹è¯•æŠ€å·§](https://react.docschina.org/docs/testing-recipes.html)**`ä¸­åŒ…å«äº†è®¸å¤šå¯ä»¥æ‹·è´ç²˜è´´çš„ç¤ºä¾‹ã€‚`**

ä¸¾ä¸ªä¾‹å­ï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰è¿™ä¹ˆä¸ªè®¡æ•°ç»„ä»¶ï¼š

```js
function Example() {
  const [count, setCount] = useState(0);
  useEffect(() => {
    document.title = `You clicked ${count} times`;
  });

  return (
    <div>
      <p>You clicked {count} times</p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
    </div>
  );
}
```

æˆ‘ä»¬ä¼šä½¿ç”¨ ReactDOM æ¥æµ‹è¯•å®ƒã€‚ä¸ºäº†ç¡®ä¿å®ƒè¡¨ç°å¾—å’Œåœ¨æµè§ˆå™¨ä¸­ä¸€æ ·ï¼Œæˆ‘ä»¬ä¼šæŠŠä»£ç æ¸²æŸ“çš„éƒ¨åˆ†åŒ…è£¹èµ·æ¥ï¼Œå¹¶æ›´æ–°ä¸º `ReactTestUtils.act()`è°ƒç”¨ï¼š

<!-- ä¸å¾—ä¸è¯´ï¼æµ‹è¯•ç¤ºä¾‹ä»£ç çš„è¯­æ³•ç»™æˆ‘çœ‹æ‡µäº†ï¼å†è®® -->

```js
import React from "react";
import ReactDOM from "react-dom";
import { act } from "react-dom/text-utils";
import Counter from "./Counter";

let container;

beforeEach(() => {
  container = document.createrElement("div");
  document.body.appendChild(container);
});

afterEach(() => {
  document.body.removeChild(container);
  // body å…ƒç´  å¯ä»¥ä» document å¯¹è±¡ä¸Šç›´æ¥è·å–
  container = null;
});

it("can render and update a counter", () => {
  // æµ‹è¯•é¦–æ¬¡æ¸²æŸ“å’Œ effect

  act(() => {
    ReactDOM.render(<Counter />, container);
  });

  const button = container.querySelector("button");
  // querySelector ä¸€ç›´ä»¥ä¸ºåªæ˜¯èƒ½åœ¨ document ä¸Šè°ƒç”¨çš„ï¼ŒåŸæ¥å¦‚ç°‡å’Œï¼Œæ˜¯æ‰€æœ‰ html å…ƒç´ çš„åŸå‹å¯¹è±¡ä¸Šçš„ æ–¹æ³•ä¹ˆ
  const label = container.querySelector("p");

  expect(label.textContent).toBe("You clicked 0 times");
  // textContent æ–‡æœ¬å†…å®¹å±æ€§
  expect(document.title).toBe("You clicked 0 times");

  act(() => {
    button.dispatchEvent(new MouseEvent("click", { bubbles: true }));
    // è¯¥å…ƒç´ è§¦å‘é¼ æ ‡ç‚¹å‡»äº‹ä»¶ æ”¯æŒå†’æ³¡
    // dispatchEvent æ–¹æ³•å’Œ MouseEvent å¯¹è±¡ï¼Œä¹Ÿéƒ½æ˜¯å¤´ä¸€æ¬¡è§
  });

  expect(label.textContent).toBe("You clicked 1 times");
  expect(document.title).toBe("You clicked 1 times");
});
```

å¯¹ act() çš„è°ƒç”¨ä¹Ÿä¼šæ¸…ç©ºä»–ä»¬å†…éƒ¨çš„ effectã€‚

å¦‚æœä½ éœ€è¦æµ‹è¯•ä¸€ä¸ªè‡ªå®šä¹‰ Hook ï¼Œä½ å¯ä»¥åœ¨ä½ çš„æµ‹è¯•ä»£ç ä¸­åˆ›å»ºä¸€ä¸ªç»„ä»¶å¹¶åœ¨å…¶ä¸­ä½¿ç”¨ä½ çš„ Hook ã€‚ç„¶åä½ å°±å¯ä»¥æµ‹è¯•ä½ åˆšå†™çš„ç»„å»ºäº†ã€‚

ä¸ºäº†å‡å°‘ä¸å¿…è¦çš„æ¨¡æ¿é¡¹ç›®ï¼Œæˆ‘ä»¬æ¨èä½¿ç”¨ React Testing Library ï¼Œè¯¥é¡¹ç›®æ—¨åœ¨é¼“åŠ±ä½ æŒ‰ç…§ç»ˆç«¯ç”¨æˆ·ä½¿ç”¨ç»„ä»¶çš„æ–¹å¼æ¥ç¼–å†™æµ‹è¯•ã€‚

æ¬²äº†è§£æ›´å¤šï¼Œè¯·å‚é˜…[é˜…è¯»æŠ€å·§](https://react.docschina.org/docs/testing-recipes.html)ä¸€èŠ‚ã€‚

#### lint è§„åˆ™å…·ä½“å¼ºåˆ¶äº†å“ªäº›å†…å®¹ï¼Ÿ

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª ESLint æ’ä»¶æ¥å¼ºåˆ¶ Hook è§„èŒƒä»¥é¿å… Bugã€‚å®ƒå‡è®¾ä»»ä½•ä»¥ã€useã€‘å¼€å¤´å¹¶ç´§è·Ÿä¸€ä¸ªå¤§å†™å­—æ¯çš„å‡½æ•°å°±æ˜¯ä¸€ä¸ª Hook ã€‚æˆ‘ä»¬çŸ¥é“è¿™ç§å¯å‘æ–¹å¼å¹¶ä¸å®Œç¾ï¼Œç”šè‡³å­˜åœ¨ä¸€äº›ä¼ªçœŸç†ï¼Œä½†å¦‚æœæ²¡æœ‰ä¸€ä¸ªå…¨ç”Ÿæ€èŒƒå›´çš„çº¦å®šå°±æ²¡æ³•è®© Hook å¾ˆå¥½çš„å·¥ä½œâ€”â€”â€”â€”è€Œåå­—å¤ªé•¿ä¼šè®©äººè¦ä¹ˆä¸æ„¿æ„é‡‡ç”¨ Hook ï¼Œè¦ä¹ˆä¸æ„¿æ„éµå®ˆçº¦å®šã€‚

è§„èŒƒå°¤å…¶å¼ºåˆ¶äº†ä¸€ä¸‹å†…å®¹ï¼š

- å¯¹ Hook çš„è°ƒç”¨è¦ä¹ˆåœ¨ä¸€ä¸ª `å¤§é©¼å³°æ³•` å‘½åçš„å‡½æ•°ï¼ˆè§†ä½œä¸€ä¸ªç»„ä»¶ï¼‰å†…éƒ¨ï¼Œè¦ä¹ˆåœ¨å¦ä¸€ä¸ª `useSomething` å‡½æ•°ï¼ˆè§†ä½œä¸€ä¸ªè‡ªå®šä¹‰ Hook ï¼‰ä¸­ã€‚
- Hook åœ¨æ¯æ¬¡æ¸²æŸ“æ—¶æŒ‰ç…§ç›¸åŒçš„é¡ºåºè°ƒç”¨ã€‚

è¿˜æœ‰ä¸€äº›å…¶ä»–çš„å¯å‘æ–¹å¼ï¼Œä½†éšç€æˆ‘ä»¬ä¸æ–­åœ°è°ƒä¼˜ä»¥åœ¨å‘ç° Bug å’Œé¿å…ä¼ªçœŸç†ä¹‹å‰å–å¾—å¹³è¡¡ï¼Œè¿™äº›æ–¹å¼éšæ—¶ä¼šæ”¹å˜ã€‚

### ä» Class è¿ç§»åˆ° Hook

#### ç”Ÿå‘½å‘¨æœŸè¦å¦‚ä½•å¯¹åº”åˆ° Hook ï¼Ÿ

- `constructor`: å‡½æ•°ç»„ä»¶ä¸éœ€è¦æ„é€ å‡½æ•°ã€‚ä½ å¯ä»¥é€šè¿‡ useState æ¥åˆå§‹åŒ– stateã€‚å¦‚æœè®¡ç®—çš„ä»£ä»·æ¯”è¾ƒæ˜‚è´µï¼Œä½ å¯ä»¥ä¼ ä¸€ä¸ªå‡½æ•°ç»™ useStateã€‚
- `getDerivedStateFromProps`: æ”¹ä¸º åœ¨æ¸²æŸ“æ—¶ å®‰æ’ä¸€æ¬¡æ›´æ–°ã€‚
- `shouldComponentUpdate`: è¯¦è§ä¸‹æ–¹ React.memo
- `render`: è¿™æ˜¯å‡½æ•°ç»„ä»¶ä½“æœ¬èº«
- `componentDidMount`,`componentDidUpdate`,`componentWillUnmount`: useEffect Hook å¯ä»¥è¡¨è¾¾æ‰€æœ‰è¿™äº›ï¼ˆåŒ…æ‹¬ä¸é‚£ä¹ˆå¸¸è§çš„åœºæ™¯ï¼‰çš„ç»„åˆã€‚
- `getSnapshotBeforeUpdate`ï¼Œ`componentDidCatch`,ä»¥åŠ `getDerivedStateFromError`ï¼šç›®å‰è¿˜æ²¡æœ‰è¿™äº›æ–¹æ³•çš„ Hook ç­‰ä»·å†™æ³•ï¼Œä½†å¾ˆå¿«ä¼šè¢«æ·»åŠ ã€‚

#### æˆ‘è¯¥å¦‚ä½•ä½¿ç”¨ Hook è¿›è¡Œæ•°æ®è·å–ï¼Ÿ

è¯¥ [demo](https://codesandbox.io/s/jvvkoo8pq3)ã€‚æ¬²äº†è§£æ›´å¤šï¼Œè¯·æŸ¥é˜…[æ­¤æ–‡ç« ](https://www.robinwieruch.de/react-hooks-fetch-data/)æ¥æ¥äº†è§£å¦‚ä½•ä½¿ç”¨ Hook è¿›è¡Œæ•°æ®è·å–ã€‚

#### æœ‰ç±»ä¼¼å®ä¾‹å˜é‡çš„ä¸œè¥¿ä¹ˆï¼Ÿ

æœ‰ï¼ `useRef` Hook ä¸ä»…å¯ä»¥ç”¨äº DOM refsã€‚ ã€refã€‘å¯¹è±¡æ˜¯ä¸€ä¸ª `current` å±æ€§å¯å˜ä¸”å¯ä»¥å®¹çº³ä»»æ„å€¼æ„å€¼çš„é€šç”¨å®¹å™¨ï¼Œç±»ä¼¼äºä¸€ä¸ª class çš„å®ä¾‹å±æ€§ã€‚

ä½ å¯ä»¥åœ¨ useEffect å†…éƒ¨å¯¹å…¶è¿›è¡Œå†™å…¥ï¼š

```js
function Timer() {
  const intervalRef = useRef();

  useEffect(() => {
    const id = setInterval(() => {
      // ...
    });

    intervalRef.current = id;

    return () => {
      clearInterval(intervalRef.current);
    };
  });
  // ...
}
```

å¦‚æœæˆ‘ä»¬åªæ˜¯æƒ³è®¾å®šä¸€ä¸ªå¾ªç¯å®šæ—¶å™¨ï¼Œæˆ‘ä»¬ä¸éœ€è¦è¿™ä¸ª ref ï¼ˆid å¯ä»¥æ˜¯åœ¨ effect æœ¬åœ°çš„ï¼‰ï¼Œä½†æ˜¯å¦‚æœæˆ‘ä»¬æƒ³è¦åœ¨ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ä¸­æ¸…æ¥šè¿™ä¸ªå¾ªç¯å®šæ—¶å™¨çš„è¯ï¼Œè¿™å°±å¾ˆæœ‰ç”¨äº†ï¼š

```js
// ...
function handleCancelClick() {
  clearInterval(intervalRef.current);
}
// ...
```

ä»æ¦‚å¿µä¸Šè®²ï¼Œä½ å¯ä»¥è®¤ä¸º refs å°±å¥½åƒæ˜¯ä¸€ä¸ª class çš„å®ä¾‹å˜é‡ã€‚é™¤éä½ æ­£åœ¨åš _æ‡’åŠ è½½_ ,å¦åˆ™é¿å…åœ¨æ¸²æŸ“æœŸé—´è®¾ç½® refs â€”â€”â€”â€” è¿™å¯èƒ½ä¼šå¯¼è‡´ä»¥å¤–çš„è¡Œä¸ºã€‚ç›¸åçš„ï¼Œé€šå¸¸ä½ èµ¢å•Šä¸ª i åœ¨äº‹ä»¶å¤„ç†å™¨å’Œ effects ä¸­ä¿®æ”¹ refsã€‚

#### æˆ‘åº”è¯¥ä½¿ç”¨å•ä¸ªè¿˜æ˜¯å¤šä¸ª state å˜é‡ï¼Ÿ

å¦‚æœä½ ä¹‹å‰ç”¨è¿‡ class ï¼Œä½ æˆ–è®¸ä¼šè¯•å›¾æ€»æ˜¯åœ¨ä¸€æ¬¡ `useState()` è°ƒç”¨ä¸­ä¼ å…¥ä¸€ä¸ªåŒ…å«äº†æ‰€æœ‰ state çš„å¯¹è±¡ã€‚å¦‚æœä½ æ„¿æ„çš„è¯ä½ å¯ä»¥è¿™ä¹ˆåšã€‚è¿™é‡Œæœ‰ä¸€ä¸ªè·Ÿè¸ªé¼ æ ‡ç§»åŠ¨çš„ç»„ä»¶çš„ä¾‹å­ã€‚æˆ‘ä»¬åœ¨æœ¬åœ° state ä¸­è®°å½•ä»–çš„ä½ç½®å’Œå°ºå¯¸ï¼š

```js
function Box() {
  const [state, setState] = useState({
    left: 0,
    top: 0,
    width: 100,
    height: 100,
  });
  // ...
}
```

ç°åœ¨å‡è®¾æˆ‘ä»¬æƒ³è¦ç¼–å†™ä¸€äº›é€»è¾‘ä»¥ä¾¿ç”¨æˆ·ç§»åŠ¨é¼ æ ‡æ—¶æ”¹å˜ left å’Œ top ã€‚æ³¨æ„åˆ°æˆ‘ä»¬æ˜¯å¦‚ä½•å¿…é¡»æ‰‹åŠ¨æŠŠè¿™äº›å­—æ®µåˆå¹¶åˆ°ä¹‹å‰çš„ state å¯¹è±¡çš„ï¼š

```js
// ...
useEffect(() => {
  function handleWindowMouseMove(e) {
    // å±•å¼€ ...state ä»¥ç¡®ä¿æˆ‘ä»¬æ²¡æœ‰ä¸¢å¤± width å’Œ height
    setState((state) => ({ ...state, left: e.pageX, top: e.pageY }));
  }
  // æ³¨æ„ï¼šè¿™æ˜¯ä¸ªç®€åŒ–ç‰ˆçš„å®ç°
  window.addEventListener("mousemove", handleWindowMouseMove);
  return () => window.removeEventListener("mousemove", handleWindowMouseMove);
}, []);
// ...
```

è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬æ›´æ–°ä¸€ä¸ª state å˜é‡ï¼Œæˆ‘ä»¬ _æ›¿æ¢_ å®ƒçš„å€¼ã€‚è¿™å’Œ class ä¸­çš„ this.setState ä¸ä¸€æ ·,åè€…ä¼šæŠŠæ›´æ–°åçš„å­—æ®µ _åˆå¹¶_ å¦‚å¯¹è±¡ä¸­ã€‚

å¦‚æœä½ é”™è¿‡è‡ªåŠ¨åˆå¹¶ï¼Œä½ å¯ä»¥å†™ä¸€ä¸ªè‡ªå®šä¹‰çš„ `useLegacyState` Hook æ¥åˆå¹¶å¯¹è±¡ state çš„æ›´æ–°ã€‚ç„¶è€Œï¼Œ**æˆ‘ä»¬æ¨èæŠŠ state åˆ‡åˆ†æˆå¤šä¸ª state å˜é‡ï¼Œæ¯ä¸ªå˜é‡åŒ…å«çš„ä¸åŒå€¼ä¼šåœ¨åŒæ—¶å‘ç”Ÿå˜åŒ–ã€‚**

ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠç»„ä»¶çš„ state æ‹†åˆ†ä¸º `position` å’Œ `size` ä¸¤ä¸ªå¯¹è±¡ï¼Œå¹¶æ°¸è¿œä»¥éåˆå¹¶çš„æ–¹å¼å»æ›¿æ¢ `position` :

```js
function Box() {
  const [postion, setPosition] = useState({ left: 0, top: 0 });
  const [size, setSize] = useState({ widht: 100, height: 100 });

  useEffect(() => {
    function handleWindowMouseMove(e) {
      setPosition({ left: e.pageX, top: e.pageY });
    }
    // ...
    // ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­çš„æ·»åŠ äº‹ä»¶ç›‘å¬å’Œç§»é™¤äº‹ä»¶ç›‘å¬æ‰æœ‰ç‚¹æ˜ç™½
  });
}
```

æŠŠç‹¬ç«‹çš„ state å˜é‡æ‹†åˆ†å¼€è¿˜æœ‰å¦å¤–çš„å¥½å¤„ã€‚è¿™ä½¿å¾—åæœŸæŠŠä¸€äº›ç›¸å…³çš„é€»è¾‘æŠ½å–åˆ°ä¸€ä¸ªè‡ªå®šä¹‰ Hook å˜å¾—å®¹æ˜“ï¼Œæ¯”å¦‚è¯´ï¼š

```js
function Box() {
  const position = useWindowPosition();
  const [size, setSize] = useState({ width: 100, height: 100 });
  // ...
}

function useWindwoPosition() {
  const [position, setPosition] = useState({ left: 0, top: 0 });

  useEffect(() => {
    // ...
  }, []);

  return position;
}
```

æ³¨æ„çœ‹æˆ‘ä»¬æ˜¯å¦‚ä½•åšåˆ°ä¸æ”¹åŠ¨ä»£ç å°±æŠŠå¯¹ position è¿™ä¸ª state å˜é‡çš„ `useStaet` è°ƒç”¨å’Œç›¸å…³çš„ effect ç§»åŠ¨åˆ°ä¸€ä¸ªè‡ªå®šä¹‰çš„ Hook çš„ã€‚å¦‚æœæ‰€æœ‰çš„ state éƒ½å­˜åœ¨åŒä¸€ä¸ªå¯¹è±¡ä¸­ï¼Œæƒ³è¦æŠ½å–å‡ºæ¥å°±æ¯”è¾ƒéš¾äº†ã€‚

æŠŠæ‰€æœ‰ state éƒ½æ”¾åœ¨åŒä¸€ä¸ª `useState` è°ƒç”¨ä¸­ï¼Œæˆ–æ˜¯æ¯ä¸€ä¸ªå­—æ®µéƒ½å¯¹åº”ä¸€ä¸ª `useState` è°ƒç”¨ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½èƒ½è·‘é€šã€‚ä½†å½“ä½ åœ¨è¿™ä¸¤ä¸ªæç«¯ä¹‹é—´æ‰¾åˆ°å¹³è¡¡ï¼Œç„¶åæŠŠç›¸å…³ state ç»„åˆåˆ°å‡ ä¸ªç‹¬ç«‹çš„ state å¯¹è±¡æ—¶ï¼Œç»„ä»¶å°±ä¼šæ›´åŠ çš„å¯è¯»ã€‚å¦‚æœ state çš„é€»è¾‘å¼€å§‹å˜å¾—å¤æ‚ï¼Œæˆ‘ä»¬æ¨èç”¨ reducer æ¥ç®¡ç†å®ƒï¼Œæˆ–ä½¿ç”¨è‡ªå®šä¹‰ Hookã€‚

#### æˆ‘å¯ä»¥åªåœ¨æ›´æ–°æ—¶è¿è¡Œ effect å—ï¼Ÿ

è¿™æ˜¯ä¸ªæ¯”è¾ƒç½•è§çš„ä½¿ç”¨åœºæ™¯ã€‚å¦‚æœä½ éœ€è¦çš„è¯ï¼Œä½ å¯ä»¥ ä½¿ç”¨ä¸€ä¸ªå¯å˜çš„ ref æ‰‹åŠ¨å­˜å‚¨ä¸€ä¸ªå¸ƒå°”å€¼æ¥è¡¨ç¤ºé¦–æ¬¡æ¸²æŸ“è¿˜æ˜¯åç»­æ¸²æŸ“ï¼Œç„¶åä½ çš„ effect ä¸­æ£€æŸ¥è¿™ä¸ªæ ‡è¯†ã€‚ï¼ˆå¦‚æœä½ å‘ç°è‡ªå·±ç»å¸¸è¿™ä¹ˆåšï¼Œä½ å¯ä»¥ä¸ºä¹‹åˆ›å»ºä¸€ä¸ªè‡ªå®šä¹‰ Hookã€‚ï¼‰

#### å¦‚ä½•è·å–ä¸Šä¸€è½®çš„ state æˆ– propsï¼Ÿ

ç›®å‰ä½ å¯ä»¥é€šè¿‡ ref æ¥æ‰‹åŠ¨å®ç°ï¼š

```js
function Counter(){
  const [count,setCount] = useState(0)

  cosnt prevCountRef = count;
  useEffect(()=>{
    prevCountRef.current = count;
  })
  cosnt prevCount = prevCountRef.current

  retrun <h1>Now:{count},before:{prevCount}</h1>
}
```

è¿™æˆ–è®¸æœ‰ä¸€ç‚¹é”™ç»¼å¤æ‚ï¼Œä½†ä½ å¯ä»¥æŠŠå®ƒæŠ½å–æˆä¸€ä¸ªè‡ªå®šä¹‰ Hook:

```js
function Counter() {
  const [count, setCount] = useState(0);
  const prevCount = usePrevious(count);

  return (
    <h1>
      Now:{count},before:{prevCount}
    </h1>
  );
}

function prevState(value) {
  const ref = useRef();

  useEffect(() => {
    ref.current = value;
  });

  return ref.current;
}
```

æ³¨æ„çœ‹è¿™æ˜¯å¦‚ä½•ä½œç”¨äº propsï¼Œstateï¼Œæˆ–ä»»ä½•å…¶ä»–è®¡ç®—å‡ºæ¥çš„å€¼çš„ã€‚

```js
function Counter() {
  const [count, setCount] = useState(0);

  const calcuation = count + 100;
  const prevCalculation = usePrevious(calculation);
  // ...
}
```

è€ƒè™‘åˆ°è¿™æ˜¯ä¸€ä¸ªç›¸å¯¹å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼Œå¾ˆå¯èƒ½åœ¨æœªæ¥ React ä¼šè‡ªå¸¦ä¸€ä¸ª usePrevious Hookã€‚

å‚è§ _derived state_ æ¨èæ¨¡å¼

#### ä¸ºä»€ä¹ˆæˆ‘ä¼šåœ¨æˆ‘çš„å‡½æ•°ä¸­çœ‹åˆ°é™ˆæ—§çš„ props å’Œ stateï¼Ÿ

ç»„ä»¶å†…éƒ¨çš„ä»»ä½•å‡½æ•°ï¼ŒåŒ…æ‹¬äº‹ä»¶å¤„ç†å‡½æ•°å’Œ effect ï¼Œéƒ½æ˜¯ä»å®ƒè¢«åˆ›å»ºçš„é‚£æ¬¡æ¸²æŸ“ä¸­è¢«ã€çœ‹åˆ°ã€‘çš„ã€‚ä¾‹å¦‚ï¼Œè€ƒè™‘è¿™æ ·çš„å¸¦å•Šï¼š

```js
function Example() {
  const [count, setCount] = useState(0);

  function handleAlertClick() {
    setTimeout(() => {
      alert("You clicked on: " + count);
    }, 3000);
  }

  return (
    <div>
      <p> You clicked {count} times </p>
      <button onClick={() => setCount(count + 1)}>Click me</button>
      <button onClick={handleAlertClick}>Show alert</button>
    </div>
  );
}
```

å¦‚æœä½ å…ˆç‚¹å‡»ã€show alertã€‘ç„¶åå¢åŠ è®¡æ•°å™¨çš„è®¡æ•°ï¼Œé‚£è¿™ä¸ª alert ä¼šæ˜¾ç¤º **åœ¨ä½ ç‚¹å‡»[Show alert]æŒ‰é’®æ—¶** çš„å˜é‡ã€‚è¿™é¿å…äº†é‚£äº›å› ä¸ºå‡è®¾ props å’Œ state æ²¡æœ‰æ”¹å˜çš„ä»£ç å¼•èµ·çš„é—®é¢˜ã€‚

å¦‚æœä½ åˆ»æ„çš„æƒ³è¦ä»æŸäº›å¼‚æ­¥å›è°ƒä¸­è¯»å–æœ€æ–°çš„ state ï¼Œä½ å¯ä»¥ç”¨ä¸€ä¸ª ref æ¥ä¿å­˜å®ƒï¼Œä¿®æ”¹å®ƒï¼Œå¹¶ä»ä¸­è¯»å–ã€‚

æœ€åï¼Œä½ çœ‹åˆ°é™ˆæ—§çš„ props å’Œ state çš„å¦å¤–ä¸€ä¸ªå¯èƒ½çš„åŸå› ï¼Œæ˜¯å› ä¸ºä½ ä½¿ç”¨äº†ã€ä¾èµ–æ•°ç»„ã€‘ä¼˜åŒ–ä½†æ²¡æœ‰æ­£ç¡®åœ°æŒ‡å®šæ‰€æœ‰çš„ä¾èµ–ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå¦‚æœä¸€ä¸ª effect åˆ¶å®šäº† [] ä½œä¸ºç¬¬äºŒä¸ªå‚æ•°ï¼Œä½†åœ¨å†…éƒ¨è¯»å–äº† `someProp`,å®ƒä¼šä¸€ç›´ã€çœ‹åˆ°ã€‘someProp çš„åˆå§‹å€¼ã€‚è§£å†³åŠæ³•æ˜¯è¦ä¹ˆç§»é™¤ä¾èµ–æ•°ç»„ï¼Œè¦ä¹ˆä¿®æ­£å®ƒã€‚è¿™é‡Œä»‹ç»äº†ä½ è¯¥[å¦‚ä½•å¤„ç†å‡½æ•°](https://react.docschina.org/docs/hooks-faq.html#is-it-safe-to-omit-functions-from-the-list-of-dependencies)ï¼Œè€Œè¿™é‡Œä»‹ç»äº†å…³äºå¦‚ä½•å‡å°‘ effect çš„è¿è¡Œè€Œä¸å¿…é”™è¯¯çš„è·³è¿‡ä»¥æ¥çš„[ä¸€äº›å¸¸è§ç­–ç•¥](https://react.docschina.org/docs/hooks-faq.html#what-can-i-do-if-my-effect-dependencies-change-too-often)ã€‚

**`æ³¨æ„ï¼š æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª exhaustive-deps ESLint è§„åˆ™ä½œä¸º eslint-plugin-react-hooks åŒ…çš„ä¸€éƒ¨åˆ†ã€‚å®ƒä¼šåœ¨ä¾èµ–é¡¹è¢«é”™è¯¯æŒ‡å®šæ—¶å‘å‡ºè­¦å‘Šï¼Œå¹¶ç»™å‡ºä¿®å¤å»ºè®®ã€‚`**

#### æˆ‘è¯¥å¦‚ä½•å®ç° getDerivedStateFromPropsï¼Ÿ

å°½ç®¡ä½ å¯èƒ½ä¸éœ€è¦å®ƒï¼Œä½†åœ¨ä¸€äº›ç½•è§çš„ä½ éœ€è¦ç”¨åˆ°çš„åœºæ™¯ä¸‹ï¼ˆæ¯”å¦‚å®ç°ä¸€ä¸ª `<Transition>` ç»„ä»¶ï¼‰ï¼Œä½ å¯èƒ½åœ¨æ¸²æŸ“è¿‡ç¨‹ä¸­æ›´æ–° state ã€‚React ä¼šç«‹å³é€€å‡ºç¬¬ä¸€æ¬¡æ¸²æŸ“å¹¶ç”¨æ›´æ–°åçš„ state é‡æ–°è¿è¡Œç»„ä»¶ä»¥é¿å…è€—è´¹å¤ªå¤šæ€§èƒ½ã€‚

è¿™é‡Œæˆ‘ä»¬æŠŠ row prop ä¸Šä¸€è½®çš„å€¼å­˜åœ¨ä¸€ä¸ª state å˜é‡ä¸­ä»¥ä¾¿æ¯”è¾ƒï¼š

```js
function ScrollView(row) {
  const [isScrollingDown, setIsScrollingDown] = useState(false);
  const [prevRow, setPrevRow] = useState(null);

  if (row !== prevRow) {
    // Row è‡ªä¸Šæ¬¡æ¸²æŸ“ä»¥æ¥å‘ç”Ÿè¿‡æ”¹å˜ã€‚ æ›´æ–° isScrollingDownã€‚
    setIsScrollingDown(prevRow !== null && row > prevRow);
    setPrevRow(row);
  }
  return `Scrolling down: ${isScrollingDown}`;
}
```

åˆçœ‹è¿™æˆ–è®¸æœ‰ç‚¹å¥‡æ€ªï¼Œä½†æ¸²æŸ“æœŸé—´çš„ä¸€æ¬¡æ›´æ–°æ°æ°å°±æ˜¯ `getDerivedStateFromProps`ä¸€ç›´ä»¥æ¥çš„æ¦‚å¿µã€‚

#### æœ‰ç±»ä¼¼ forceUpdate çš„ä¸œè¥¿ä¹ˆï¼Ÿ

å¦‚æœå‰åä¸¤æ¬¡çš„å€¼ç›¸åŒï¼ŒuseState å’Œ useReducer Hook éƒ½ä¼šæ”¾å¼ƒæ›´æ–°ã€‚åŸåœ°ä¿®æ”¹ state å¹¶è°ƒç”¨ setState ä¸ä¼šå¼•èµ·é‡æ–°æ¸²æŸ“ã€‚

é€šå¸¸ï¼Œä½ ä¸åº”è¯¥åœ¨ React ä¸­ä¿®æ”¹æœ¬åœ° stateï¼Œç„¶è€Œï¼Œä½œä¸ºä¸€æ¡å‡ºè·¯ï¼Œä½ å¯ä»¥ç”¨ä¸€ä¸ªå¢é•¿çš„è®¡æ•°å™¨æ¥åœ¨ state æ²¡å˜çš„æ—¶å€™ä¾ç„¶å¼ºåˆ¶ä¸€æ¬¡é‡æ–°æ¸²æŸ“ï¼š

```js
const [ignored, forceUpdate] = useReducer((x) => x + 1, 0);

function handleClick() {
  forceUpdate();
}
```

å¯èƒ½çš„è¯å°½é‡é¿å…è¿™ç§æ¨¡å¼ã€‚

#### æˆ‘å¯ä»¥å¼•ç”¨ä¸€ä¸ªå‡½æ•°ç»„ä»¶ä¹ˆï¼Ÿ

å°½ç®¡ä½ ä¸åº”è¯¥ç»å¸¸è¿™ä¹ˆåšï¼Œä½†ä½ å¯ä»¥é€šè¿‡ `useImperativeHandle` Hook æš´éœ²ä¸€äº›å‘½ä»¤å¼çš„æ–¹æ³•ç»™çˆ¶ç»„ä»¶ã€‚

#### æˆ‘è¯¥å¦‚ä½•æµ‹é‡ DOM èŠ‚ç‚¹ï¼Ÿ

è·å– DOM èŠ‚ç‚¹çš„ä½ç½®æˆ–æ˜¯å¤§å°çš„åŸºæœ¬æ–¹å¼æ˜¯ä½¿ç”¨ callback refã€‚æ¯å½“ ref è¢«é™„åŠ åˆ°ä¸€ä¸ªå¦ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒReact å°±ä¼šè°ƒç”¨ callbackã€‚è¿™é‡Œæœ‰ä¸€ä¸ªå° demoï¼š

```js
function MeasureExample() {
  const [height, setHeight] = useState(0);
  const measuredRef = useCallback((node) => {
    if (node !== null) {
      setHeight(node.getBoundingClientRect().height);
    }
  }, []);

  return (
    <>
      <h1 ref={measuredRef}>Hello,world</h1>
      <h2>The above header id {Math.round(heigth)}px</h2>
    </>
  );
}
```

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­æˆ‘ä»¬æ²¡æœ‰é€‰æ‹©ä½¿ç”¨ useRef ï¼Œå› ä¸ºå½“ ref æ˜¯ä¸€ä¸ªå¯¹è±¡æ—¶å®ƒå¹¶ä¸ä¼šæŠŠå½“å‰ ref çš„å€¼å¾— _å˜åŒ–_ é€šçŸ¥æˆ‘ä»¬ã€‚ä½¿ç”¨ callback ref å¯ä»¥ç¡®ä¿ å³ä¾¿å­ç»„ä»¶å»¶è¿Ÿæ˜¾ç¤ºè¢«æµ‹é‡çš„èŠ‚ç‚¹ï¼ˆæ¯”å¦‚ä¸ºäº†å“åº”ä¸€æ¬¡ç‚¹å‡»ï¼‰ï¼Œæˆ‘ä»¬ä¾ç„¶èƒ½å¤Ÿåœ¨çˆ¶ç»„ä»¶æ¥æ”¶åˆ°ç›¸å…³çš„ä¿¡æ¯ï¼Œä»¥ä¾¿æ›´æ–°æµ‹é‡ç»“æœã€‚

æ³¨æ„åˆ°æˆ‘ä»¬ä¼ é€’äº† [] ä½œä¸º useCallback çš„ä¾èµ–é¡¹åˆ—è¡¨ã€‚è¿™ç¡®ä¿äº† ref callback ä¸ä¼šå†å†æ¬¡æ¸²æŸ“æ—¶æ”¹å˜ï¼Œå› æ­¤ React ä¸ä¼šåœ¨éå¿…è¦çš„æ—¶å€™è°ƒç”¨å®ƒã€‚

åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œå½“ä¸”ä»…å½“ç»„ä»¶æŒ‚è½½å’Œå¸è½½æ—¶æ”¹å˜ï¼Œcallback ref æ‰ä¼šè¢«è°ƒç”¨ï¼Œå› ä¸ºæ¸²æŸ“çš„ `<h1></h1>` ç»„ä»¶åœ¨æ•´ä¸ªé‡æ–°æ¸²æŸ“æœŸé—´å§‹ç»ˆå­˜åœ¨ã€‚å¦‚æœä½ å¸Œæœ›åœ¨æ¯æ¬¡ç»„ä»¶è°ƒæ•´å¤§å°æ—¶éƒ½æ”¶åˆ°é€šçŸ¥ï¼Œåˆ™å¯èƒ½éœ€è¦ä½¿ç”¨ `ResizeObserver` æˆ–åŸºäºå…¶æ„å»ºç¬¬ä¸‰æ–¹ Hookã€‚

å¦‚æœä½ æ„¿æ„ï¼Œä½ å¯ä»¥æŠŠè¿™ä¸ªé€»è¾‘æŠ½å–å‡ºæ¥åšä¸€ä¸ªå¯å¤ç”¨çš„ Hookï¼š

```js
function MeasureExample() {
  const [rect, ref] = useClientRect();
  return (
    <>
      <h1 ref={ref}>Hello, world</h1>
      {rect !== null && (
        <h2>The above header is {Math.round(rect.height)}px tall</h2>
      )}>
    </>
  );
}

function useClientRect() {
  const [rect, setRectL] = useState(null);

  const ref = useCallback((node) => {
    if (node !== null) {
      setRect(node.getBoundingClientRect());
    }
  }, []);
  return [rect, ref];
}
```

### æ€§èƒ½ä¼˜åŒ–

#### æˆ‘å¯ä»¥åœ¨æ›´æ–°æ—¶æ¡å¤ effect å—ï¼Ÿ

å¯ä»¥çš„ã€‚å‚è§æ¡ä»¶å¼çš„å‘èµ· effect ï¼Œæ³¨æ„ï¼Œå¿˜è®°å¤„ç†æ›´æ–°å¸¸ä¼šå¯¼è‡´ bugï¼Œè¿™ä¹Ÿæ­£æ˜¯æˆ‘ä»¬æ²¡æœ‰é»˜è®¤ä½¿ç”¨æ¡ä»¶å¼ effect çš„åŸå› ã€‚

#### åœ¨ä¾èµ–é¡¹åˆ—è¡¨ä¸­çœç•¥å‡½æ•°æ˜¯å¦å®‰å…¨ï¼Ÿ

ä¸€èˆ¬æ¥è¯´ï¼Œä¸å®‰å…¨ã€‚

```js
function Example({ someProp }) {
  function doSomething() {
    console.log(someProp);
  }

  useEffect(() => {
    doSomething();
  }, []);
  // ğŸ”´ è¿™æ ·ä¸å®‰å…¨ï¼ˆå®ƒè°ƒç”¨çš„ doSomething å‡½æ•°ä½¿ç”¨äº† someProp
}
```

è¦è®°ä½ effect å¤–éƒ¨çš„å‡½æ•°ä½¿ç”¨äº†å“ªäº› props å’Œ state å¾ˆéš¾ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ **é€šå¸¸ä½ ä¼šæƒ³è¦åœ¨ effect å†…éƒ¨å»å£°æ˜å®ƒæ‰€éœ€è¦çš„å‡½æ•°ã€‚**è¿™æ ·å°±èƒ½å®¹æ˜“çš„çœ‹å‡ºå“ªä¸ª effect ä¾èµ–äº†ç»„ä»¶ä½œç”¨åŸŸä¸­çš„å“ªäº›å€¼ï¼š

```js
function Example({ someProp }) {
  useEffect(() => {
    function doSomething() {
      console.log(someProp);
    }

    doSomething();
  }, [someProp]); // âœ… å®‰å…¨ï¼ˆæˆ‘ä»¬çš„ effect ä»…ç”¨åˆ°äº† `someProp`ï¼‰
}
```

å¦‚æœè¿™æ ·ä¹‹åæˆ‘ä»¬ä¾ç„¶æ²¡ç”¨åˆ°ç»„ä»¶ä½œç”¨åŸŸä¸­çš„ä»»ä½•å€¼ï¼Œå°±å¯ä»¥å®‰å…¨åœ°æŠŠå®ƒæŒ‡å®šä¸º []ï¼š

```js
useEffect(() => {
  function doSomething() {
    console.log("hello");
  }

  doSomething();
}, []); // âœ… åœ¨è¿™ä¸ªä¾‹å­ä¸­æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰ç”¨åˆ°ç»„ä»¶ä½œç”¨åŸŸä¸­çš„ *ä»»ä½•* å€¼
```

æ ¹æ®ä½ çš„ç”¨ä¾‹ï¼Œä¸‹é¢åˆ—ä¸¾äº†ä¸€äº›å…¶ä»–çš„åŠæ³•ã€‚

**`æ³¨æ„: æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª exhaustive-deps ESLint è§„åˆ™ä½œä¸º eslint-plugin-react-hooks åŒ…çš„ä¸€éƒ¨åˆ†ã€‚å®ƒä¼šå¸®åŠ©ä½ æ‰¾å‡ºæ— æ³•ä¸€è‡´åœ°å¤„ç†æ›´æ–°çš„ç»„ä»¶ã€‚`**

è®©æˆ‘ä»¬æ¥çœ‹çœ‹è¿™æœ‰ä»€ä¹ˆå…³ç³»ã€‚

å¦‚æœä½ æŒ‡å®šäº†ä¸€ä¸ªä»¥æ¥åˆ—è¡¨ä½œä¸º useEffectã€useLayoutEffectã€useMemoã€useCallback æˆ– useEmperativeHandle çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œå®ƒå¿…é¡»åŒ…å«å›è°ƒä¸­çš„æ‰€æœ‰å€¼ï¼Œå¹¶å‚ä¸ React æ•°æ®æµã€‚è¿™å°±åŒ…æ‹¬ propsã€stateï¼Œä»¥åŠä»»ä½•å®ƒä»¬è¡ç”Ÿå‡ºæ¥çš„ä¸œè¥¿ã€‚

åªæœ‰å½“å‡½æ•°ï¼ˆä»¥åŠä»–æ‰€è°ƒç”¨çš„å‡½æ•°ï¼‰ä¸å¼•ç”¨ propsã€state ä»¥åŠç”±å®ƒä»¬è¡ç”Ÿå‡ºæ¥çš„å€¼æ—¶ï¼Œä½ æ‰å¯ä»¥æ”¾å¿ƒåœ°æŠŠå®ƒä»¬ä»ä¾èµ–é¡¹åˆ—è¡¨ä¸­çœç•¥ã€‚ä¸‹é¢è¿™ä¸ªæ¡ˆä¾‹ä¸­æœ‰ä¸€ä¸ª Bugï¼š

```js
function ProductPage({ productId }) {
  const [product, setProduct] = useState(null);

  async function fetchProduct() {
    const response = await fetch('http://myapi/product/' + productId); // ä½¿ç”¨äº† productId prop
    const json = await response.json();
    setProduct(json);
  }

  useEffect(() => {
    fetchProduct();
  }, []); // ğŸ”´ è¿™æ ·æ˜¯æ— æ•ˆçš„ï¼Œå› ä¸º `fetchProduct` ä½¿ç”¨äº† `productId`
  // ...
}
```

**æ¨èçš„ä¿®å¤æ–¹æ¡ˆæ˜¯æŠŠé‚£ä¸ªå‡½æ•°ç§»åŠ¨åˆ°ä½ çš„ effect å†…éƒ¨ã€‚**è¿™æ ·å°±èƒ½å¾ˆå®¹æ˜“çš„çœ‹å‡ºæ¥ä½ çš„ effect ä½¿ç”¨äº†å“ªäº› props å’Œ stateï¼Œå¹¶ç¡®ä¿å®ƒä»¬éƒ½è¢«å£°æ˜äº†ï¼š

```js
function ProductPage({ productId }){
  const [product,setProduct] = useState(null)

  useEffect(()=>{
    //  æŠŠè¿™ä¸ªå‡½æ•°ç§»åŠ¨åˆ° effect å†…éƒ¨åï¼Œæˆ‘ä»¬å¯ä»¥æ¸…æ¥šåœ°çœ‹åˆ°å®ƒç”¨åˆ°çš„å€¼ã€‚
    async function fetchProduct(){
      const response = await fetch('http://myapi/product/'+productId);
      const json = response.json();
      setProduct(json)
    }
    fetchProduct()
  },[productId])
  // æœ‰æ•ˆï¼Œå› ä¸ºæˆ‘ä»¬çš„ effect åªç”¨åˆ°äº† productId
  // ...
}
```

è¿™åŒæ—¶ä¹Ÿå…è®¸ä½ é€šè¿‡ effect å†…éƒ¨çš„å±€éƒ¨å˜é‡æ¥å¤„ç†æ— åºçš„å“åº”ï¼š

```js
useEffect(()=>{
  let ignore = false;
  async function fetchProduct(){
    const response = await fetch('http://maapi/product/'+productId)
    const json = await response.json();

    if(!ignore) setProduct(json)
  }

  fetchProduct();

  return ()=>{ ignore = true}
}ï¼Œ[productId])
```

æˆ‘ä»¬æŠŠè¿™ä¸ªå‡½æ•°ç§»åŠ¨åˆ° effect å†…éƒ¨ï¼Œè¿™æ ·å®ƒå°±ä¸ç”¨å‡ºç°åœ¨å®ƒçš„ä¾èµ–åˆ—è¡¨ä¸­äº†ã€‚

**`æç¤ºï¼š çœ‹çœ‹è¿™ä¸ªå° [demo](https://codesandbox.io/s/jvvkoo8pq3) å’Œ [è¿™ç¯‡æ–‡ç« ](https://www.robinwieruch.de/react-hooks-fetch-data/) æ¥äº†è§£æ›´å¤šå…³äºå¦‚ä½•ç”¨ Hook è¿›è¡Œæ•°æ®è·å–ã€‚`**

**å¦‚æœå¤„äºæŸäº›åŸå› ä½ æ— æ³•æŠŠä¸€ä¸ªå‡½æ•°ç§»åŠ¨åˆ° effect å†…éƒ¨ï¼Œè¿˜æœ‰ä¸€äº›å…¶ä»–åŠæ³•ï¼š**


